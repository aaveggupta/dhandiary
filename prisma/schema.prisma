generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String              @id // Clerk user ID
  email              String              @unique
  firstName          String?
  lastName           String?
  imageUrl           String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  accounts           Account[]
  transactions       Transaction[]
  categories         Category[]
  settings           UserSettings?
  sharedCreditLimits SharedCreditLimit[]
}

model UserSettings {
  id                 String   @id @default(cuid())
  userId             String   @unique
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  currency           String   @default("USD")
  monthlyIncome      Decimal? @db.Decimal(12, 2)
  onboardingComplete Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model SharedCreditLimit {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String    // e.g., "HDFC Combined Limit"
  totalLimit  Decimal   @db.Decimal(12, 2)
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  accounts    Account[]

  @@index([userId])
}

model Account {
  id                      String             @id @default(cuid())
  userId                  String
  user                    User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  name                    String
  type                    AccountType
  balance                 Decimal            @default(0) @db.Decimal(12, 2)
  creditLimit             Decimal?           @db.Decimal(12, 2) // Only for CREDIT type accounts
  currency                String             @default("USD")
  icon                    String?
  bankName                String?            // Bank or card issuer name
  lastFourDigits          String?            // Last 4 digits of account/card number
  description             String?            // Custom nickname or description
  isArchived              Boolean            @default(false)
  sharedCreditLimitId     String?
  sharedCreditLimit       SharedCreditLimit? @relation(fields: [sharedCreditLimitId], references: [id], onDelete: SetNull)
  // Credit card specific fields
  billingCycleDay         Int?               // Day of month when billing cycle ends (1-31)
  paymentDueDay           Int?               // Day of month when payment is due (1-31)
  utilizationAlertEnabled Boolean            @default(true) // Enable utilization alerts
  utilizationAlertPercent Int                @default(30) // Alert when utilization exceeds this %
  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt
  transactions            Transaction[]      @relation("TransactionSource")
  transfersIn             Transaction[]      @relation("TransferDestination")

  @@index([userId])
  @@index([sharedCreditLimitId])
}

model Transaction {
  id                    String          @id @default(cuid())
  userId                String
  user                  User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount                Decimal         @db.Decimal(12, 2)
  type                  TransactionType
  categoryId            String?
  category              Category?       @relation(fields: [categoryId], references: [id])
  accountId             String
  account               Account         @relation("TransactionSource", fields: [accountId], references: [id], onDelete: Cascade)
  destinationAccountId  String?
  destinationAccount    Account?        @relation("TransferDestination", fields: [destinationAccountId], references: [id], onDelete: SetNull)
  note                  String?
  date                  DateTime        @default(now())
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  @@index([userId])
  @@index([accountId])
  @@index([destinationAccountId])
  @@index([categoryId])
  @@index([date])
}

model Category {
  id           String          @id @default(cuid())
  userId       String?
  user         User?           @relation(fields: [userId], references: [id], onDelete: Cascade)
  name         String
  icon         String?
  color        String?
  type         TransactionType
  isSystem     Boolean         @default(false)
  transactions Transaction[]

  @@index([userId])
  @@index([type])
}

enum AccountType {
  BANK      // Bank accounts (Salary, Savings, Current)
  CREDIT    // Credit cards
  CASH      // Physical cash/wallet
}

enum TransactionType {
  INCOME
  EXPENSE
  TRANSFER
}

// Global bank dictionary - shared across all users
model Bank {
  id        String   @id @default(cuid())
  name      String   @unique // Bank name (e.g., "HDFC Bank", "Chase")
  country   String   @default("IN") // Country code (IN, US, etc.)
  isSystem  Boolean  @default(false) // Pre-seeded banks vs user-added
  createdAt DateTime @default(now())

  @@index([country])
  @@index([name])
}
